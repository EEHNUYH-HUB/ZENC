<?xml version="1.0" encoding="utf-8" ?>
<SmartSqlMap Scope="SQL"  xmlns="http://SmartSql.net/schemas/SmartSqlMap.xsd">
	<Statements>
		<Statement Id="SELLOCATION">
			SELECT * FROM TBL_LOCATION
		</Statement>
		<Statement Id="SELSIMPLEMEMBER">
			SELECT * FROM TBL_MEMBER ORDER BY PK_ID
		</Statement>
		<Statement Id="SELMEMBER">




SELECT 			A.*
			,	COALESCE(B.WINCNT,0) AS WINCNT
			,	COALESCE(B.TIECNT,0) AS TIECNT
			,	COALESCE(B.LOSSCNT,0) AS LOSSCNT
			,	COALESCE(C.GOAL,0) AS GOAL
			,	COALESCE(C.ASSIST,0) AS ASSIST
			,	COALESCE(C.SAVE,0) AS SAVE
			,	COALESCE(B.WINCNT,0)*3 + COALESCE(B.TIECNT,0) AS TEAMSCORE
			,	COALESCE(C.GOAL,0)*5 + COALESCE(C.ASSIST,0) *2 + COALESCE(C.SAVE,0)*1 AS MEMBERSCORE
FROM 			TBL_MEMBER A
LEFT OUTER JOIN		(
					SELECT 	A.MEMBER_ID
						,	SUM(A.WINCNT) AS WINCNT
						,	SUM(A.TIECNT) AS TIECNT
						,	SUM(A.LOSSCNT) AS LOSSCNT
					FROM (
							SELECT 		B.FK_MEMBER_ID AS MEMBER_ID
								,		SUM(CASE WHEN A.COL_LEFT_SCORE > A.COL_RIGHT_SCORE THEN 1 ELSE 0 END) AS WINCNT
								,		SUM(CASE WHEN A.COL_LEFT_SCORE = A.COL_RIGHT_SCORE THEN 1 ELSE 0 END) AS TIECNT
								,		SUM(CASE WHEN A.COL_RIGHT_SCORE > A.COL_LEFT_SCORE THEN 1 ELSE 0 END) AS LOSSCNT
							FROM 		TBL_PLAY A
							INNER JOIN 	TBL_TEAM B ON A.FK_LEAGUE_ID = B.FK_LEAGUE_ID AND A.FK_LEFT_TEAM_ID = B.FK_TEAM_TYPE_ID
							GROUP BY	B.FK_MEMBER_ID
							UNION ALL
							SELECT 		B.FK_MEMBER_ID AS MEMBER_ID
								,		SUM(CASE WHEN A.COL_RIGHT_SCORE > A.COL_LEFT_SCORE THEN 1 ELSE 0 END) AS WINCNT
								,		SUM(CASE WHEN A.COL_LEFT_SCORE = A.COL_RIGHT_SCORE THEN 1 ELSE 0 END) AS TIECNT
								,		SUM(CASE WHEN A.COL_LEFT_SCORE > A.COL_RIGHT_SCORE THEN 1 ELSE 0 END) AS LOSSCNT
							FROM 		TBL_PLAY A
							INNER JOIN 	TBL_TEAM B ON A.FK_LEAGUE_ID = B.FK_LEAGUE_ID AND A.FK_RIGHT_TEAM_ID = B.FK_TEAM_TYPE_ID
							GROUP BY	B.FK_MEMBER_ID
						) A
					GROUP BY A.MEMBER_ID
				) B ON A.PK_ID = B.MEMBER_ID
LEFT OUTER JOIN (
					SELECT 		FK_MEMBER_ID
						,		SUM(CASE WHEN COL_TYPE = 0 THEN 1 ELSE 0 END) AS GOAL
						,		SUM(CASE WHEN COL_TYPE = 1 THEN 1 ELSE 0 END) AS ASSIST
						,		SUM(CASE WHEN COL_TYPE = 2 THEN 1 ELSE 0 END) AS SAVE
					FROM 		TBL_PLAY_DETAIL
					GROUP BY	FK_MEMBER_ID
				) C ON A.PK_ID = C.FK_MEMBER_ID
ORDER BY A.PK_ID

			
		</Statement>
		<Statement Id="CHKMEMBER">
			SELECT PK_ID FROM TBL_MEMBER WHERE COL_NAME = @name AND COL_BIRTHDAY = @birthday
		</Statement>
		<Statement Id="INSERTMEMBER">
			INSERT INTO TBL_MEMBER(COL_NAME,COL_PHONE,COL_BIRTHDAY) VALUES (@name, @phone,@birthday) 
		</Statement>
		<Statement Id="UPDATEMEMBER">
			UPDATE TBL_MEMBER
			SET COL_NAME = @name
			,	COL_PHONE = @phone
			,	COL_BIRTHDAY = @birthday
			WHERE PK_ID = @pkid
		</Statement>

		<Statement Id="CHKLOCATION">
			SELECT PK_ID FROM TBL_LOCATION WHERE COL_NAME = @name
		</Statement>
		<Statement Id="INSERTLOCATION">
			INSERT INTO TBL_LOCATION(COL_NAME,COL_ADDRESS,COL_ADDRESS2,COL_LATITUDE,COL_LONGITUDE) VALUES (@name, @add,@add2,@la,@lo)
		</Statement>
		<Statement Id="UPDATELOCATION">
			UPDATE TBL_LOCATION
			SET COL_NAME = @name
			,	COL_ADDRESS = @add
			,	COL_ADDRESS2 = @add2
			,	COL_LATITUDE = @la
			,	COL_LONGITUDE = @lo
			WHERE PK_ID = @pkid
		</Statement>
		<Statement Id="SELLEAGUEEDIT">
			SELECT 				A.PK_ID
							,	A.FK_LOCATION_ID
							,	A.COL_DATE
							,	A.COL_STATUS 
							,	B.COL_NAME AS LOCATIONNAME 
			FROM 				TBL_LEAGUE A 
			LEFT OUTER  JOIN 	TBL_LOCATION B ON B.PK_ID  = A.FK_LOCATION_ID 
			WHERE  				5 > A.COL_STATUS 
		</Statement>
		<Statement Id="INSERTLEAGUE">
			INSERT INTO TBL_LEAGUE (COL_STATUS) VALUES(1);
			SELECT MAX(PK_ID) FROM TBL_LEAGUE;
		</Statement>
		<Statement Id="UPDATELEAGUE">
			UPDATE 	TBL_LEAGUE
			SET		FK_LOCATION_ID = @fk_location_id
			,		COL_DATE = @col_date
			,		COL_STATUS = @col_status
			WHERE   PK_ID = @pk_id
		</Statement>
		<Statement Id="UPDATELEAGUESTATUS">
			UPDATE 	TBL_LEAGUE
			SET		COL_STATUS = @col_status
			WHERE   PK_ID = @pk_id
		</Statement>
		<Statement Id="SELTEAMTYPES">
			SELECT * FROM TBL_TEAM_TYPE
		</Statement>
		<Statement Id="SELLEAGUEPLAYER">
			SELECT				A.*
			,					C.COL_NAME AS TEAM_NAME
			,					B.COL_NAME
			,					C.COL_TYPE
			FROM				TBL_TEAM A
			INNER JOIN			TBL_MEMBER B ON A.FK_MEMBER_ID = B.PK_ID
			LEFT OUTER JOIN		TBL_TEAM_TYPE C ON A.FK_TEAM_TYPE_ID = C.PK_ID
			WHERE				A.FK_LEAGUE_ID =@leagueid
			ORDER BY			B.PK_ID
		</Statement>
		<Statement Id="INSERTLEAGUEPLAYER">
			INSERT INTO TBL_TEAM (FK_LEAGUE_ID,FK_MEMBER_ID) VALUES (@leagueid,@memberid)
		</Statement>
		<Statement Id="UPDATETEAMMAPPING">
			UPDATE TBL_TEAM
			SET		FK_TEAM_TYPE_ID = @fk_team_type_id
			WHERE	FK_LEAGUE_ID = @leagueid 
			AND		FK_MEMBER_ID = @playerid
		</Statement>
		<Statement Id="DELETELEAGUEPLAYER">
			DELETE FROM TBL_TEAM WHERE FK_LEAGUE_ID = @leagueid;
		</Statement>
		<Statement Id="INSERTGAME">
			INSERT INTO TBL_PLAY
			(
					FK_LEAGUE_ID
				,	FK_LEFT_TEAM_ID
				,	FK_RIGHT_TEAM_ID
				,	COL_LEFT_SCORE
				,	COL_RIGHT_SCORE
			)
			VALUES
			(
					@fk_league_id
				,	@fk_left_team_id
				,	@fk_right_team_id
				,	@leftscore
				,	@rightscore
			);

			SELECT MAX(PK_ID) FROM TBL_PLAY;
		</Statement>
		<Statement Id="UPDATEGAME">
			UPDATE		TBL_PLAY
			SET			COL_LEFT_SCORE = @leftscore
			,			COL_RIGHT_SCORE =@rightscore
			WHERE		PK_ID = @pk_id
		</Statement>
		<Statement Id="DELETEGAMEDTL">
			DELETE FROM TBL_PLAY_DETAIL WHERE FK_PLAY_ID = @pk_id;
		</Statement>
		<Statement Id="DELETEGAME">
			DELETE FROM TBL_PLAY WHERE PK_ID = @pk_id;
		</Statement>
		
		<Statement Id="INSERTGAMEDTL">
			INSERT INTO TBL_PLAY_DETAIL
			(
				FK_PLAY_ID
			,	COL_TYPE
			,	FK_MEMBER_ID
			)
			VALUES
			(
				@playid
			,	@coltype
			,	@memberid
			);

			
		</Statement>

		<Statement Id="SELLEAGUEPLAYLIST">
			SELECT * FROM TBL_PLAY WHERE FK_LEAGUE_ID =@leagueid ORDER BY PK_ID
		</Statement>
		<Statement Id="DELETELEAGUE">
			DELETE FROM TBL_LEAGUE WHERE PK_ID = @id
		</Statement>
		<Statement Id="SELLEAGUEHISTORY">
SELECT 		A.PK_ID 
	,		A.FK_LOCATION_ID
	,		A.COL_DATE
	,		C.COL_NAME AS TEAMNAME
	,		C.COL_TYPE AS TEAMTYPE
	,		E.COL_NAME AS LOCATIONNAME
	,		B.WINCNT
	,		B.TIECNT
	,		B.LOSSCNT
FROM 		TBL_LEAGUE		A
INNER JOIN	(
			SELECT 		A.FK_LEAGUE_ID
				,		A.TEAMID
				,		SUM(A.WINCNT) AS WINCNT
				,		SUM(A.TIECNT) AS TIECNT
				,		SUM(A.LOSSCNT) AS LOSSCNT
			FROM		(
						SELECT 		A.FK_LEAGUE_ID
							, 		A.FK_LEFT_TEAM_ID  AS TEAMID
							,		SUM(CASE WHEN A.COL_LEFT_SCORE > A.COL_RIGHT_SCORE THEN 1 ELSE 0 END) AS WINCNT
							,		SUM(CASE WHEN A.COL_LEFT_SCORE = A.COL_RIGHT_SCORE THEN 1 ELSE 0 END) AS TIECNT
							,		SUM(CASE WHEN A.COL_RIGHT_SCORE > A.COL_LEFT_SCORE THEN 1 ELSE 0 END) AS LOSSCNT
						FROM 		TBL_PLAY A
						GROUP BY	A.FK_LEAGUE_ID, A.FK_LEFT_TEAM_ID
						UNION ALL
						SELECT 		A.FK_LEAGUE_ID
							, 		A.FK_RIGHT_TEAM_ID AS TEAMID
							,		SUM(CASE WHEN A.COL_RIGHT_SCORE > A.COL_LEFT_SCORE THEN 1 ELSE 0 END) AS WINCNT
							,		SUM(CASE WHEN A.COL_LEFT_SCORE = A.COL_RIGHT_SCORE THEN 1 ELSE 0 END) AS TIECNT
							,		SUM(CASE WHEN A.COL_LEFT_SCORE > A.COL_RIGHT_SCORE THEN 1 ELSE 0 END) AS LOSSCNT
						FROM 		TBL_PLAY A
						GROUP BY	A.FK_LEAGUE_ID, A.FK_RIGHT_TEAM_ID
						) A
			GROUP BY 	A.FK_LEAGUE_ID,A.TEAMID
			) 		B 	ON 	A.PK_ID = B.FK_LEAGUE_ID
INNER JOIN 	TBL_TEAM_TYPE 	C 	ON 	B.TEAMID = C.PK_ID
INNER JOIN 	TBL_LOCATION	E 	ON	A.FK_LOCATION_ID = E.PK_ID
WHERE 		A.COL_STATUS = 5;

SELECT 		A.PK_ID AS LEAGUEID
	,		C.PK_ID AS PLAYERID
	,		COALESCE(D.PLAYERSCORE,0) 	AS PLAYERSCORE
	,		COALESCE(D.GOAL,0) 			AS GOAL
	,		COALESCE(D.ASSIST,0) 		AS ASSIST
	,		COALESCE(D.SAVE,0) 			AS SAVE
	,		C.COL_NAME
	,		E.COL_NAME 					AS TEAMNAME
	,		E.COL_TYPE					AS TEAMTYPE
FROM					TBL_LEAGUE A
INNER JOIN 				TBL_TEAM   B ON A.PK_ID = B.FK_LEAGUE_ID
INNER JOIN 				TBL_MEMBER C ON B.FK_MEMBER_ID = C.PK_ID
INNER JOIN 				TBL_TEAM_TYPE E ON E.PK_ID= B.FK_TEAM_TYPE_ID
LEFT OUTER JOIN			(
						SELECT 	 	A.FK_LEAGUE_ID
								,	B.FK_MEMBER_ID
								,	SUM(
										CASE WHEN COL_TYPE = 0 
										THEN 5 
										ELSE CASE WHEN COL_TYPE = 1 
											THEN 2
											ELSE CASE WHEN COL_TYPE = 2
												THEN
												1
												ELSE
												0
												END

											END
										END 
									) AS PLAYERSCORE
								,	SUM(CASE WHEN COL_TYPE = 0 THEN 1 ELSE 0 END) AS GOAL
								,	SUM(CASE WHEN COL_TYPE = 1 THEN 1 ELSE 0 END) AS ASSIST
								,	SUM(CASE WHEN COL_TYPE = 2 THEN 1 ELSE 0 END) AS SAVE	
						FROM 		TBL_PLAY 		A
						INNER JOIN 	TBL_PLAY_DETAIL B ON A.PK_ID = B.FK_PLAY_ID
						GROUP BY  	B.FK_MEMBER_ID , A.FK_LEAGUE_ID
						) D ON B.FK_LEAGUE_ID = D.FK_LEAGUE_ID AND B.FK_MEMBER_ID = D.FK_MEMBER_ID

WHERE 		A.COL_STATUS = 5
ORDER BY	COALESCE(D.PLAYERSCORE,0) DESC;
</Statement>
		
	</Statements>
</SmartSqlMap>